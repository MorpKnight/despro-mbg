name: Build Tauri Linux

on:
    push:
        branches: [main, master]
        tags:
            - "v*"
    pull_request:
        branches: [main, master]
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build-linux:
        runs-on: ubuntu-22.04

        env:
            EXPO_PUBLIC_API_URL: ${{ vars.EXPO_PUBLIC_API_URL || 'https://mbg-be.mrt.qzz.io/api/v1' }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Linux dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libwebkit2gtk-4.0-dev \
                    libwebkit2gtk-4.1-dev \
                    libappindicator3-dev \
                    librsvg2-dev \
                    patchelf \
                    libgtk-3-dev \
                    libayatana-appindicator3-dev

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: Install dependencies
              run: npm ci

            - name: Build web assets
              run: npx expo export -p web
              env:
                  EXPO_PUBLIC_API_URL: ${{ env.EXPO_PUBLIC_API_URL }}

            - name: Generate Tauri icons
              run: |
                  # Create icons directory
                  mkdir -p src-tauri/icons
                  # Generate icons from logo (ImageMagick is available on Ubuntu runners)
                  convert assets/images/icon.png -resize 256x256 -background white -gravity center -extent 256x256 src-tauri/icons/icon.png
                  convert src-tauri/icons/icon.png src-tauri/icons/icon.ico
                  convert src-tauri/icons/icon.png -resize 32x32 src-tauri/icons/32x32.png
                  convert src-tauri/icons/icon.png -resize 128x128 src-tauri/icons/128x128.png
                  convert src-tauri/icons/icon.png -resize 256x256 src-tauri/icons/128x128@2x.png

            - name: Build Tauri app
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: v__VERSION__
                  releaseName: "MBG-lance v__VERSION__"
                  releaseBody: "Aplikasi desktop MBG-lance"
                  releaseDraft: true
                  prerelease: false

            - name: Upload Linux artifact
              uses: actions/upload-artifact@v4
              with:
                  name: mbg-lance-linux
                  path: |
                      src-tauri/target/release/bundle/deb/*.deb
                      src-tauri/target/release/bundle/appimage/*.AppImage
                      src-tauri/target/release/bundle/rpm/*.rpm
                  if-no-files-found: warn
